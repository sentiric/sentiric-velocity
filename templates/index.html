<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VeloCache Y√∂netim Paneli</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        :root {
            --background-color: #f7f8fc; --card-background: #ffffff; --text-color: #333;
            --primary-color: #005a9c; --secondary-color: #6c757d; --danger-color: #dc3545;
            --danger-hover-color: #c82333; --border-radius: 12px; --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            --font-family: 'Inter', sans-serif;
        }
        body { font-family: var(--font-family); background-color: var(--background-color); color: var(--text-color); margin: 0; padding: 40px 20px; }
        .container { width: 100%; max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 40px; }
        .header h1 { font-size: 2.5rem; font-weight: 700; color: var(--primary-color); display: flex; align-items: center; justify-content: center; gap: 15px; }
        .header p { font-size: 1.1rem; color: var(--secondary-color); }
        .rocket-icon { font-size: 2.5rem; }
        .setup-notice { background-color: #e6f0ff; border: 1px solid #b3d1ff; padding: 20px; border-radius: var(--border-radius); margin-bottom: 30px; text-align: left;}
        .setup-notice h2 { margin-top: 0; color: var(--primary-color); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background-color: var(--card-background); border-radius: var(--border-radius); box-shadow: var(--box-shadow); padding: 20px; text-align: center; }
        .stat-title { font-size: 0.9rem; font-weight: 600; color: var(--secondary-color); margin-bottom: 10px; }
        .stat-value { font-size: 2rem; font-weight: 700; color: var(--primary-color); }
        .btn { background-color: var(--danger-color); color: white; border: none; border-radius: 8px; padding: 10px 20px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: background-color 0.2s ease, transform 0.2s ease; }
        .btn:hover { background-color: var(--danger-hover-color); transform: translateY(-2px); }
        .btn-primary { background-color: var(--primary-color); }
        .btn-primary:hover { background-color: #004a80; }
        .btn-small { padding: 4px 8px; font-size: 0.8rem; }
        .controls { margin-bottom: 30px; display: flex; justify-content: center; gap: 20px; }
        .section { background-color: var(--card-background); border-radius: var(--border-radius); box-shadow: var(--box-shadow); padding: 20px; margin-bottom: 30px; }
        .section h2 { margin-top: 0; }
        #log-output { background-color: #2d333b; color: #cdd9e5; padding: 15px; border-radius: 8px; height: 300px; overflow-y: scroll; font-family: 'Courier New', Courier, monospace; font-size: 0.9rem; white-space: pre-wrap; word-wrap: break-word; }
        table { width: 100%; border-collapse: collapse; }
        th, td { text-align: left; padding: 12px 15px; border-bottom: 1px solid #eee; }
        th { font-weight: 600; color: var(--secondary-color); }
        tr:last-child td { border-bottom: none; }
        .url-cell { max-width: 400px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1><span class="rocket-icon">üöÄ</span> VeloCache Y√∂netim Paneli</h1>
            <p>Ger√ßek zamanlƒ± proxy ve cache istatistikleri</p>
        </header>

        <main>
            <div class="setup-notice">
                <h2>Ba≈ülangƒ±√ß Adƒ±mlarƒ±</h2>
                <p>HTTPS trafiƒüini √∂nbelleƒüe almak i√ßin, VeloCache'in K√∂k G√ºven Sertifikasƒ±nƒ± indirip sisteminize y√ºklemeniz gerekir. Bu i≈ülemi bir kere yapmanƒ±z yeterlidir.</p>
                <button class="btn btn-primary" onclick="downloadCert()">1. G√ºven Sertifikasƒ±nƒ± ƒ∞ndir (.crt)</button>
                <p class="small-text" style="font-size: 0.8rem; color: #555; margin-top: 10px;">
                    <b>Kurulum:</b> Sertifikayƒ± indirdikten sonra √ºzerine √ßift tƒ±klayƒ±n ve ≈üu adƒ±mlarƒ± izleyin: <i>"Sertifika Y√ºkle" -> "Yerel Makine" -> "T√ºm sertifikalarƒ± a≈üaƒüƒ±daki depolama alanƒ±na yerle≈ütir" -> "G√∂zat" -> "G√ºvenilen K√∂k Sertifika Yetkilileri" -> "Tamam"</i>.
                </p>
            </div>

            <div class="stats-grid">
                <div class="stat-card"><div class="stat-title">Durum</div><div class="stat-value" id="status">...</div></div>
                <div class="stat-card"><div class="stat-title">Hit Oranƒ±</div><div class="stat-value" id="hitRate">...%</div></div>
                <div class="stat-card"><div class="stat-title">Toplam ƒ∞stek</div><div class="stat-value" id="totalRequests">...</div></div>
                <div class="stat-card"><div class="stat-title">Bellekteki √ñƒüe</div><div class="stat-value" id="itemCount">...</div></div>
                <div class="stat-card"><div class="stat-title">Disk Cache Boyutu</div><div class="stat-value" id="cacheSize">...</div></div>
                <div class="stat-card"><div class="stat-title">Kazan√ß (Cache'den)</div><div class="stat-value" id="dataSaved">...</div></div>
            </div>

            <div class="controls">
                <button class="btn" onclick="clearCache()">üóëÔ∏è T√ºm Cache'i Temizle</button>
            </div>
            
            <div class="section">
                <h2>Cache Girdileri</h2>
                <div style="max-height: 400px; overflow-y: auto;">
                    <table id="cache-entries">
                        <thead><tr><th>URL</th><th>ƒ∞√ßerik Tipi</th><th>Boyut</th><th>Ya≈ü</th><th>ƒ∞≈ülem</th></tr></thead>
                        <tbody><tr><td colspan="5" style="text-align:center;">Y√ºkleniyor...</td></tr></tbody>
                    </table>
                </div>
            </div>

            <div class="section">
                <h2>Canlƒ± Loglar</h2>
                <pre id="log-output"></pre>
            </div>
        </main>
    </div>

    <script>
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${wsProtocol}//${window.location.host}/api/logs`;
        let socket;

        function connectWebSocket() {
            socket = new WebSocket(wsUrl);
            const logOutput = document.getElementById('log-output');

            socket.onopen = () => { logOutput.innerHTML += 'Log akƒ±≈üƒ±na baƒülanƒ±ldƒ±.\n'; };
            socket.onmessage = (event) => {
                logOutput.innerHTML += event.data + '\n';
                logOutput.scrollTop = logOutput.scrollHeight;
            };
            socket.onclose = () => {
                logOutput.innerHTML += 'Log akƒ±≈ü baƒülantƒ±sƒ± kesildi. 3 saniye i√ßinde yeniden denenecek...\n';
                setTimeout(connectWebSocket, 3000);
            };
            socket.onerror = (error) => { console.error('WebSocket hatasƒ±:', error); };
        }

        function formatBytes(bytes, decimals = 2) {
            if (!bytes || bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        function formatAge(dateString) {
            const now = new Date();
            const then = new Date(dateString);
            const diffSeconds = Math.round((now - then) / 1000);

            if (diffSeconds < 60) return `${diffSeconds} sn √∂nce`;
            const diffMinutes = Math.round(diffSeconds / 60);
            if (diffMinutes < 60) return `${diffMinutes} dk √∂nce`;
            const diffHours = Math.round(diffMinutes / 60);
            if (diffHours < 24) return `${diffHours} sa √∂nce`;
            const diffDays = Math.round(diffHours / 24);
            return `${diffDays} g√ºn √∂nce`;
        }

        // --- BU FONKSƒ∞YON G√úNCELLENDƒ∞ ---
        async function refreshDashboard() {
            try {
                const response = await fetch('/api/dashboard');
                if (!response.ok) {
                     document.getElementById('status').textContent = 'Hata';
                    throw new Error('API hatasƒ±: ' + response.statusText);
                }
                const data = await response.json();

                // ƒ∞statistikleri g√ºncelle
                document.getElementById('status').textContent = "Aktif";
                document.getElementById('itemCount').textContent = data.stats.in_memory_items;
                document.getElementById('cacheSize').textContent = formatBytes(data.stats.total_disk_size_bytes);
                document.getElementById('dataSaved').textContent = formatBytes(data.stats.data_served_from_cache_bytes);
                document.getElementById('totalRequests').textContent = data.stats.total_requests;

                const hits = data.stats.hits;
                const total = data.stats.total_requests;
                const hitRate = total > 0 ? (hits / total) * 100 : 0;
                document.getElementById('hitRate').textContent = hitRate.toFixed(1) + '%';

                // √ñnbellek girdilerini g√ºncelle
                const tbody = document.querySelector('#cache-entries tbody');
                tbody.innerHTML = '';
                
                if (data.entries.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Cache bo≈ü.</td></tr>';
                    return;
                }

                for (const entry of data.entries) {
                    const row = document.createElement('tr');
                    const contentType = entry.headers['content-type'] || 'N/A';
                    row.innerHTML = `
                        <td class="url-cell" title="${entry.url}">${entry.url}</td>
                        <td>${contentType.split(';')[0]}</td>
                        <td>${formatBytes(entry.size)}</td>
                        <td>${formatAge(entry.created_at)}</td>
                        <td><button class="btn btn-small" onclick="deleteEntry('${entry.hash}')">Sil</button></td>
                    `;
                    tbody.appendChild(row);
                }

            } catch (error) {
                console.error('Dashboard verileri alƒ±namadƒ±:', error);
                document.getElementById('status').textContent = 'Hata';
                document.querySelector('#cache-entries tbody').innerHTML = '<tr><td colspan="5" style="text-align:center;">Girdiler y√ºklenemedi.</td></tr>';
            }
        }
        
        // ESKƒ∞ refreshStats ve refreshEntries fonksiyonlarƒ± KALDIRILDI

        async function deleteEntry(hash) {
            if (!confirm('Bu cache girdisini silmek istediƒüinizden emin misiniz?')) return;
            try {
                const response = await fetch(`/api/entries/${hash}`, { method: 'DELETE' });
                if (!response.ok) throw new Error('Girdi silinemedi.');
                refreshDashboard(); // Sildikten sonra t√ºm paneli yenile
            } catch(error) {
                alert('Hata: ' + error.message);
            }
        }

        async function clearCache() {
            if (!confirm('T√ºm bellek ve disk cache\'i kalƒ±cƒ± olarak temizlenecek. Emin misiniz?')) return;
            try {
                const response = await fetch('/api/clear', { method: 'POST' });
                if (!response.ok) throw new Error('Cache temizlenemedi.');
                alert('Cache ba≈üarƒ±yla temizlendi!');
                refreshDashboard(); // Temizledikten sonra t√ºm paneli yenile
            } catch (error) {
                alert('Hata: ' + error.message);
            }
        }

        function downloadCert() {
            window.location.href = '/api/ca.crt';
        }

        document.addEventListener('DOMContentLoaded', () => {
            connectWebSocket();
            refreshDashboard();
            setInterval(refreshDashboard, 5000); // Artƒ±k tek bir fonksiyonu √ßaƒüƒ±rƒ±yoruz
        });
    </script>
</body>
</html>